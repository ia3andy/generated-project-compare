name: Generate Quarkus Projects

on:
  workflow_dispatch:
    inputs:
      quarkus_version:
        description: 'Quarkus version (leave empty for latest)'
        required: false
        type: string

jobs:
  generate-project:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        build_tool: [maven, gradle, gradle-kotlin-dsl]

    steps:
      - name: Checkout workflow branch
        uses: actions/checkout@v4
        with:
          ref: workflow

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install JBang
        run: |
          curl -Ls https://sh.jbang.dev | bash -s - app setup
          echo "$HOME/.jbang/bin" >> $GITHUB_PATH

      - name: Install Quarkus CLI
        run: |
          jbang trust add https://repo1.maven.org/maven2/io/quarkus/quarkus-cli/
          if [ -n "${{ inputs.quarkus_version }}" ]; then
            echo "Installing Quarkus CLI version ${{ inputs.quarkus_version }}"
            jbang app install --fresh --force --name quarkus "https://repo1.maven.org/maven2/io/quarkus/quarkus-cli/${{ inputs.quarkus_version }}/quarkus-cli-${{ inputs.quarkus_version }}-runner.jar"
          else
            echo "Installing latest Quarkus CLI"
            jbang app install --fresh --force quarkus@quarkusio
          fi

      - name: Get Quarkus version
        id: quarkus_version
        run: |
          VERSION=$(quarkus version)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected Quarkus CLI version: $VERSION"

      - name: Set build tool flag
        id: build_tool_flag
        run: |
          case "${{ matrix.build_tool }}" in
            maven)
              echo "flag=--maven" >> $GITHUB_OUTPUT
              ;;
            gradle)
              echo "flag=--gradle" >> $GITHUB_OUTPUT
              ;;
            gradle-kotlin-dsl)
              echo "flag=--gradle-kotlin-dsl" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Checkout build tool branch
        run: |
          git fetch origin ${{ matrix.build_tool }}
          git checkout ${{ matrix.build_tool }}    

      - name: Clean
        run: |
          # Remove all files except .git
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
      

      - name: Generate project
        run: |
          if [ -n "${{ inputs.quarkus_version }}" ]; then
            quarkus create app com.example:project:1.0.0-SNAPSHOT ${{ steps.build_tool_flag.outputs.flag }} -P io.quarkus.platform:quarkus-bom:${{ inputs.quarkus_version }}
          else
            quarkus create app com.example:project:1.0.0-SNAPSHOT ${{ steps.build_tool_flag.outputs.flag }}
          fi

      - name: Move project files
        run: |
          # Move generated project contents to root
          mv project/* project/.??* . 2>/dev/null || true
          rmdir project

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push changes
        run: |
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          COMMIT_MSG="Generate ${{ matrix.build_tool }} project with Quarkus ${{ steps.quarkus_version.outputs.version }}"
          git commit -m "$COMMIT_MSG"
          git push origin ${{ matrix.build_tool }}
          echo "Changes committed and pushed: $COMMIT_MSG"

      - name: Tag the commit
        if: steps.quarkus_version.outputs.version != 'unknown'
        run: |
          TAG_NAME="${{ matrix.build_tool }}-${{ steps.quarkus_version.outputs.version }}"

          # Check if tag exists on remote
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME"; then
            echo "Tag $TAG_NAME already exists on remote, skipping"
            exit 0
          fi

          git tag -a "$TAG_NAME" -m "Generated ${{ matrix.build_tool }} project with Quarkus ${{ steps.quarkus_version.outputs.version }}"
          git push origin "$TAG_NAME"
          echo "Created and pushed tag: $TAG_NAME"